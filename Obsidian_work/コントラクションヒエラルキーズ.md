#ChatGPT #用語 #アルゴリズム

```
質問：
「コントラクションヒエラルキーズ」とはどのような概念か、どのような特徴があり、どのように使われるかを教えてください。
```

**コントラクション・ヒエラルキーズ（Contraction Hierarchies ; CH）とは**  
グラフ（とくに道路網）の**最短経路探索を桁違いに高速化するための前処理付きアルゴリズム**です。2008 年に独カールスルーエ工科大学の Geisberger らが提案し 【_Faster and Simpler Hierarchical Routing in Road Networks_】として発表されました。([i11www.iti.kit.edu](https://i11www.iti.kit.edu/extra/publications/gssd-chfsh-08.pdf?utm_source=chatgpt.com "[PDF] Contraction Hierarchies: Faster and Simpler Hierarchical Routing in ..."))

---

### 1. 基本アイデア

1. **ノードの重要度付け**  
    走行量・接続度などの指標で「重要な交差点」を高レベル、「住宅街の袋小路」を低レベルに並べ替えます。
    
2. **収縮（contraction）**  
    重要度の低いノードから順に “潰す” ように取り除きます。その際、取り除かれたノードを経由する最短経路を保つため、**ショートカット（shortcut）** 辺を追加します。
    
3. **階層付きグラフが完成**  
    収縮が終わると、元の道路網 + ショートカット + ノードの階層情報（レベル）が得られます。
    
4. **問合せ（検索）**  
    ビディレクショナル Dijkstra を **「上位レベルにしか登らない」** 制限付きで走らせると、探索範囲が劇的に縮まり、欧州大陸規模でも数ミリ秒〜数十ミリ秒で経路が返ります。([GraphHopper Directions API](https://www.graphhopper.com/blog/2017/08/14/flexible-routing-15-times-faster/?utm_source=chatgpt.com "Now flexible routing is at least 15 times faster - GraphHopper"))
    

---

### 2. 主要な特徴

|特徴|説明|
|---|---|
|**正確性**|近似ではなく“厳密な最短経路”が得られる。|
|**高速応答**|大陸規模で Dijkstra の10³〜10⁴倍高速（µs〜ms レベル）。|
|**前処理型**|1回の重い前処理で多数のクエリを高速化。静的ネットワークに向く。|
|**メモリ効率**|追加されるショートカットは元エッジの20〜50 %程度。|
|**拡張性**|ターン制限対応の _Edge-based CH_、動的コストに強い _Customizable CH (CCH)_、GPU/並列化版（SPoCH 2024 など）が存在。([arXiv](https://arxiv.org/abs/2412.18008?utm_source=chatgpt.com "Parallel Contraction Hierarchies Can Be Efficient and Scalable"))|

---

### 3. 主な利用シーン

|ドメイン|具体例|理由|
|---|---|---|
|オープンソース経路検索|**OSRM** では `osrm-contract` が CH 前処理を行い、オンライン API が µs 多重化を実現。([GitHub](https://github.com/Project-OSRM/osrm-backend?utm_source=chatgpt.com "GitHub - Project-OSRM/osrm-backend: Open Source Routing Machine"))||
|オフライン・モバイルナビ|**GraphHopper** の _speed mode_ は CH を使い、携帯端末でも世界地図を扱える。([GitHub](https://github.com/graphhopper/graphhopper/blob/master/docs/core/routing.md?utm_source=chatgpt.com "graphhopper/docs/core/routing.md at master - GitHub"))||
|MaaS／物流最適化|大量ルートを高速に繰り返し評価できるため車両ルート最適化や配車シミュレーションに好適。||
|ゲーム開発|広大なオープンワールドでの NPC ルート計算をサーバー側で高速化。||

---

### 4. 使い方の概略（OSRM 例）

```bash
# ① OSM データを抽出（Lua プロファイルで重み付け）
osrm-extract  japan-latest.osm.pbf -p car.lua  

# ② 収縮階層を構築（数分〜数時間）
osrm-contract japan-latest.osrm   

# ③ サーバ起動：最短経路クエリがミリ秒級
osrm-routed  japan-latest.osrm
```

GraphHopper では `graph.flagEncoders=car` → `prepare.ch.weightings=fastest` と設定するだけで CH が有効になります。([GraphHopper Directions API](https://www.graphhopper.com/blog/2022/06/27/host-your-own-worldwide-route-calculator-with-graphhopper/?utm_source=chatgpt.com "Host Your Own Worldwide Route Calculator With GraphHopper"))

---

### 5. 適用時の注意点とベストプラクティス

- **頻繁に変わるコスト**（リアルタイム交通・天候など）は再前処理が必要。対策として _CCH_ や _MLD (Multi-Level Dijkstra)_ を併用。
    
- **前処理が重い** → 並列版 (SPoCH) や GPU 実装で短縮可能。
    
- **ショートカット数の爆発** を防ぐには適切な重要度ヒューリスティック（エッジ差分、近傍度など）が必須。
    
- **回避オプション**（有料道路禁止など）は「プロファイルごとに前処理」または CCH で重み変更に対応。([GraphHopper Forum](https://discuss.graphhopper.com/t/how-to-preprocess-multiple-route-restrictions-efficiently-in-speed-mode-ch/9399?utm_source=chatgpt.com "How to Preprocess Multiple Route Restrictions Efficiently in Speed ..."))
    

---

## まとめ

コントラクション・ヒエラルキーズは

> **「前処理で重い計算を肩代わりし、問い合せを桁違いに高速化する厳密最短経路アルゴリズム」**

という位置付けです。静的で大規模なネットワーク（道路網など）を扱うナビゲーション・物流・ゲーム分野で広く採用され、オープンソース実装も充実しています。適用時は「前処理コストと動的更新ニーズ」のバランスを取りながら、必要に応じて CCH や MLD などの派生技術を組み合わせると良いでしょう。
